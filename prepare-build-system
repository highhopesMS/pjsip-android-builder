#!/bin/bash -e

. config.conf

# Check if script is run with sudo privileges
HAS_PRIVILEGES=$(id -u)
if [ $HAS_PRIVILEGES -ne 0 ]
then
  echo "Run as root or with sudo"
  exit 1
fi

# Create Download directory if it does not exist
if [ ! -d "$DOWNLOAD_DIR" ]
then
  mkdir $DOWNLOAD_DIR
fi

# Create Build directory if it does not exist
if [ ! -d "$BUILD_DIR" ]
then
  mkdir $BUILD_DIR
fi

if [ "$SETUP_PACKAGES" == "1" ]
then
    # Setup Java 17 (required for Android SDK command line tools)
    apt-get update
    apt-get purge -y openjdk*
    apt-get install -y openjdk-17-jdk

    DEPS="unzip git curl bzip2 binutils make autoconf openssl \
          libssl-dev libopus0 libpcre3 libpcre3-dev libpcre2-dev build-essential nasm python3"

    # Only add i386 architecture on x86_64 systems (not needed on ARM)
    if [ "$(uname -m)" = "x86_64" ]; then
        dpkg --add-architecture i386
    fi

    apt-get update && apt-get -y upgrade && apt-get install -y ${DEPS}
fi

if [ "$DOWNLOAD_NDK" == "1" ]
then
    if [ -d "$DOWNLOAD_DIR/$NDK_DIR_NAME" ]
    then
        echo ""
        echo "Android NDK ${NDK_VERSION} already exists, skipping download..."
        echo ""
    else
        echo ""
        echo "Downloading Android NDK ${NDK_VERSION} ..."
        echo ""

        cd $DOWNLOAD_DIR
        curl -L -# -o ndk.zip "$NDK_DOWNLOAD_URL" 2>&1
        rm -rf "$NDK_DIR_NAME"
        echo ""
        echo "Android NDK downloaded!"
        echo ""
        echo "Extracting Android NDK ..."
        echo ""
        unzip ndk.zip -d ndk
        mv ndk/$NDK_DIR_NAME .
        rm -rf ndk
        rm -rf ndk.zip
    fi
fi

# Create compatibility symlinks for NDK r23+ (libc++ STL path changed)
# PJSIP's configure-android looks for old path: sources/cxx-stl/llvm-libc++/libs/<arch>
# But NDK r23+ has it at: toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/<target>
# This must run even if NDK was already downloaded to ensure symlinks exist
NDK_PATH="$DOWNLOAD_DIR/$NDK_DIR_NAME"
OLD_STL_PATH="$NDK_PATH/sources/cxx-stl/llvm-libc++/libs"

if [ -d "$NDK_PATH" ] && [ ! -d "$OLD_STL_PATH/armeabi-v7a" ]; then
    echo "Creating NDK compatibility symlinks for PJSIP..."
    mkdir -p "$NDK_PATH/sources/cxx-stl/llvm-libc++/libs"

    # Map arch names to target triplets
    declare -A ARCH_MAP
    ARCH_MAP["armeabi-v7a"]="arm-linux-androideabi"
    ARCH_MAP["arm64-v8a"]="aarch64-linux-android"
    ARCH_MAP["x86"]="i686-linux-android"
    ARCH_MAP["x86_64"]="x86_64-linux-android"

    TOOLCHAIN_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib"

    for arch in "${!ARCH_MAP[@]}"; do
        target="${ARCH_MAP[$arch]}"
        if [ -d "$TOOLCHAIN_SYSROOT/$target" ]; then
            mkdir -p "$OLD_STL_PATH/$arch"
            # Find libc++_shared.so in the target directory
            if [ -f "$TOOLCHAIN_SYSROOT/$target/libc++_shared.so" ]; then
                ln -sf "$TOOLCHAIN_SYSROOT/$target/libc++_shared.so" "$OLD_STL_PATH/$arch/libc++_shared.so"
                echo "  Created symlink for $arch"
            fi
        fi
    done
    echo "NDK compatibility symlinks created!"
fi

if [ "$DOWNLOAD_SDK" == "1" ]
then
    if [ -d "$DOWNLOAD_DIR/$SDK_DIR_NAME/$CMD_TOOLS/$CMD_TOOLS_DIR_NAME" ]
    then
        echo ""
        echo "Android SDK already exists, skipping download..."
        echo ""
    else
        CMD_ZIP_FILE="$CMD_TOOLS.zip"

        echo ""
        echo "Downloading Android CMD Line Tools version ${CMD_TOOLS_VERSION} ..."
        cd $DOWNLOAD_DIR
        curl -L -# -o $CMD_ZIP_FILE $CMD_TOOLS_DOWNLOAD_URL 2>&1
        echo ""
        echo "Android CMD Tools downloaded!"
        echo "Extracting Android CMD Tools ..."
        rm -rf $SDK_DIR_NAME
        unzip -d $SDK_DIR_NAME $CMD_ZIP_FILE

        # Remove zip file
        rm -rf $CMD_ZIP_FILE

        # Create empty repositories.cfg file to avoid warning
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg

        # Since new updates, there are some changes that are not mentioned in the documentation.
        # After unzipping the command line tools package, the top-most directory you'll get is $CMD_TOOLS.
        # Rename the unpacked directory from $CMD_TOOLS to $CMD_TOOLS_DIR_NAME, and place it under $ANDROID_HOME/$CMD_TOOLS
        # which will then look like $ANDROID_HOME/$CMD_TOOLS/$CMD_TOOLS_DIR_NAME
        cd $SDK_DIR_NAME/$CMD_TOOLS
        mkdir -p $CMD_TOOLS_DIR_NAME
        mv `ls | grep -w -v $CMD_TOOLS_DIR_NAME` $CMD_TOOLS_DIR_NAME
    fi
fi

if [ "$DOWNLOAD_ANDROID_APIS" == "1" ]
then
    echo "Exporting ANDROID_HOME"
    export ANDROID_HOME=$DOWNLOAD_DIR/$SDK_DIR_NAME
    SDK_MANAGER=$ANDROID_HOME/$CMD_TOOLS/$CMD_TOOLS_DIR_NAME/bin/sdkmanager
    echo "Downloading Android Platforms"
    for api in ${SETUP_ANDROID_APIS[@]}
    do
        echo yes | $SDK_MANAGER "platforms;android-$api"
    done

    echo "Downloading Android Platform-Tools"
    echo yes | $SDK_MANAGER "platform-tools"
    echo "Exporting TOOLS & PLATFORM_TOOLS"
    export PATH=$ANDROID_HOME/platform-tools/:$ANDROID_HOME/tools:$PATH

    echo "Downloading Android Build-Tools"
    echo yes | $SDK_MANAGER "build-tools;$ANDROID_BUILD_TOOLS"
fi

if [ "$DOWNLOAD_PJSIP" == "1" ]
then
    if [ -d "$DOWNLOAD_DIR/$PJSIP_DIR_NAME" ]
    then
        echo ""
        echo "PJSIP ${PJSIP_VERSION} already exists, skipping download..."
        echo "(Delete $DOWNLOAD_DIR/$PJSIP_DIR_NAME to force re-download)"
        echo ""
    else
        echo ""
        echo "Downloading PJSIP ${PJSIP_VERSION} ..."
        echo ""
        cd $DOWNLOAD_DIR
        pjsipFile="pjsip.tar.gz"
        curl -L -# -o $pjsipFile "$PJSIP_DOWNLOAD_URL" 2>&1
        rm -rf "$PJSIP_DIR_NAME"
        echo "PJSIP downloaded!"
        echo "Extracting PJSIP ..."
        tar xzf $pjsipFile && rm -rf $pjsipFile

        PATCH_DIR=$BASEDIR/patches

        # Fixed Call-ID PATCH
        if [ "${USE_FIXED_CALLID}" == "1" ]
            then
            echo ""
            echo ""
            echo "######################################################################"
            echo "Apply patch to use a fixed Call-ID in registration ..."
            echo "######################################################################"
            echo ""
            cd $PATCH_DIR/fixed_callid
            ./patch.sh
            cd $BASEDIR
        fi

        # Rtcp-FB-Event data to pjsua2 PATCH
        if [ "${EXPORT_RTCP_FB_DATA}" == "1" ]
            then
            echo ""
            echo ""
            echo "######################################################################"
            echo "Apply patch to export RTCP-FB Event data to pjsua2 ..."
            echo "######################################################################"
            echo ""
            cd $PATCH_DIR/export_rtcp_fb
            ./patch.sh
            cd $BASEDIR
        fi

        # Fix missing contact header PATCH
        if [ "${FIX_MISSING_CONTACT_HEADER}" == "1" ]
            then
            echo ""
            echo ""
            echo "######################################################################"
            echo "Apply patch to fix missing contact header ..."
            echo "######################################################################"
            echo ""
            cd $PATCH_DIR/fix_missing_contact_header_on_incall_ip_change
            ./patch.sh
            cd $BASEDIR
        fi
    fi
fi

if [ "$DOWNLOAD_SWIG" == "1" ]
then
    # Check if SWIG is already installed with the correct version
    if command -v swig &> /dev/null && swig -version 2>/dev/null | grep -q "$SWIG_VERSION"
    then
        echo ""
        echo "SWIG ${SWIG_VERSION} already installed, skipping..."
        echo ""
    else
        echo ""
        echo "Downloading SWIG ${SWIG_VERSION} ..."
        echo ""
        cd $DOWNLOAD_DIR
        curl -L -# -o swig.tar.gz "$SWIG_DOWNLOAD_URL" 2>&1
        rm -rf "$SWIG_DIR_NAME"
        echo "SWIG downloaded!"
        echo "Extracting SWIG ..."
        tar xzf swig.tar.gz && rm -rf swig.tar.gz
        cd "$SWIG_DIR_NAME"
        mkdir -p $SWIG_BUILD_OUT_PATH
        echo "Configuring SWIG ..."
        ./configure >> "$SWIG_BUILD_OUT_PATH/swig.log" 2>&1
        echo "Compiling SWIG ..."
        make >> "$SWIG_BUILD_OUT_PATH/swig.log" 2>&1
        echo "Installing SWIG ..."
        make install >> "$SWIG_BUILD_OUT_PATH/swig.log" 2>&1
        cd ..
        rm -rf "$SWIG_DIR_NAME"
    fi
fi

if [ "$DOWNLOAD_OPENSSL" == "1" ]
then
    # Check if OpenSSL was already built (check for libs directory with content)
    if [ -d "$OPENSSL_BUILD_OUT_PATH/libs" ] && [ "$(ls -A $OPENSSL_BUILD_OUT_PATH/libs 2>/dev/null)" ]
    then
        echo ""
        echo "OpenSSL ${OPENSSL_VERSION} already built, skipping..."
        echo "(Delete $OPENSSL_BUILD_OUT_PATH to force rebuild)"
        echo ""
    else
        echo ""
        echo "Downloading OpenSSL ${OPENSSL_VERSION} ..."
        echo ""

        cd $DOWNLOAD_DIR
        curl -L -# -o openssl.tar.gz "$OPENSSL_DOWNLOAD_URL" 2>&1
        rm -rf "$OPENSSL_DIR_NAME"
        echo "OpenSSL downloaded!"
        echo "Extracting OpenSSL ..."
        tar xzf openssl.tar.gz && rm -rf openssl.tar.gz
        cd "${BASEDIR}"
        ./openssl-build-target-archs
    fi
fi

if [ "$DOWNLOAD_OPENH264" == "1" ]
then
    # Check if OpenH264 was already built
    if [ -d "$OPENH264_BUILD_OUT_PATH/libs" ] && [ "$(ls -A $OPENH264_BUILD_OUT_PATH/libs 2>/dev/null)" ]
    then
        echo ""
        echo "OpenH264 ${OPENH264_VERSION} already built, skipping..."
        echo "(Delete $OPENH264_BUILD_OUT_PATH to force rebuild)"
        echo ""
    else
        echo ""
        echo "Downloading OpenH264 ${OPENH264_VERSION} ..."
        echo ""
        cd $DOWNLOAD_DIR
        curl -L -# -o openh264.tar.gz "$OPENH264_DOWNLOAD_URL" 2>&1
        rm -rf "${OPENH264_DIR_NAME}"
        echo "OpenH264 downloaded!"
        echo "Extracting OpenH264 ..."
        tar xzf openh264.tar.gz && rm -rf openh264.tar.gz

        if [ "$SKIP_OPENH264_DEMO" == "1" ]
        then
            echo "Modifying platform-android.mk to skip Encdemo and Decdemo builds"
            sed -e "/binaries: decdemo encdemo/ s/^#*/#/" -i ${OPENH264_DIR_NAME}/build/platform-android.mk
        fi
        cd ${BASEDIR}
        ./openh264-build-target-archs || true
    fi
fi

if [ "$DOWNLOAD_OPUS" == "1" ]
then
    # Check if Opus was already built
    if [ -d "$OPUS_BUILD_OUT_PATH/libs" ] && [ "$(ls -A $OPUS_BUILD_OUT_PATH/libs 2>/dev/null)" ]
    then
        echo ""
        echo "Opus ${OPUS_VERSION} already built, skipping..."
        echo "(Delete $OPUS_BUILD_OUT_PATH to force rebuild)"
        echo ""
    else
        echo ""
        echo "Downloading Opus ${OPUS_VERSION} ..."
        echo ""
        cd "$DOWNLOAD_DIR"
        curl -L -# -o opus.tar.gz "$OPUS_DOWNLOAD_URL" 2>&1
        rm -rf "${OPUS_DIR_NAME}"
        echo "Opus downloaded!"
        echo "Extracting Opus ..."
        tar xzf opus.tar.gz && rm -rf opus.tar.gz
        cd ${BASEDIR}
        ./opus-build || true
    fi
fi

if [ "${DOWNLOAD_BCG729}" == "1" ]
then
    # Check if BCG729 was already built
    if [ -d "$BCG729_BUILD_OUT_PATH/libs" ] && [ "$(ls -A $BCG729_BUILD_OUT_PATH/libs 2>/dev/null)" ]
    then
        echo ""
        echo "BCG729 ${BCG729_VERSION} already built, skipping..."
        echo "(Delete $BCG729_BUILD_OUT_PATH to force rebuild)"
        echo ""
    else
        echo ""
        echo "Downloading bcg729 $BCG729_VERSION ..."
        echo ""
        cd "$DOWNLOAD_DIR"
        rm -rf "${BCG729_DIR_NAME}"
        mkdir $BCG729_DIR_NAME
        git clone -b $BCG729_VERSION $BCG729_DOWNLOAD_URL $BCG729_DIR_NAME
        echo "bcg729 downloaded!"
        cd ${BASEDIR}
        ./bcg729-build || true
    fi
fi

if [ "${DOWNLOAD_OBOE}" == "1" ]
then
    # Check if Oboe was already set up (check for prefab structure)
    if [ -d "$OBOE_BUILD_OUT_PATH/prefab/modules/oboe/include" ]
    then
        echo ""
        echo "Oboe ${OBOE_VERSION} already set up, skipping..."
        echo "(Delete $OBOE_BUILD_OUT_PATH to force re-setup)"
        echo ""
    else
        echo ""
        echo "Downloading Oboe ${OBOE_VERSION} ..."
        echo ""
        cd "$DOWNLOAD_DIR"
        rm -rf "${OBOE_DIR_NAME}"
        mkdir -p "${OBOE_DIR_NAME}"

        # Download the AAR file
        curl -L -# -o oboe.aar "$OBOE_DOWNLOAD_URL" 2>&1
        echo "Oboe downloaded!"

        # Extract the AAR (it's a zip file)
        echo "Extracting Oboe prefab package ..."
        unzip -q oboe.aar -d "${OBOE_DIR_NAME}"
        rm -f oboe.aar

        # Setup output directories - maintain prefab structure for PJSIP compatibility
        # PJSIP's configure-android expects: $PREFIX/prefab/modules/oboe/include and
        # $PREFIX/prefab/modules/oboe/libs/android.$ABI
        rm -rf "${OBOE_BUILD_OUT_PATH}"
        mkdir -p "${OBOE_BUILD_OUT_PATH}"

        echo "Setting up Oboe with prefab structure for PJSIP ..."

        # Copy the entire prefab directory structure
        cp -r "${OBOE_DIR_NAME}/prefab" "${OBOE_BUILD_OUT_PATH}/"

        echo "Oboe setup completed!"
    fi
fi

if [ "${DOWNLOAD_OBOE}" == "1" ]
then
    echo ""
    echo "Downloading Oboe ${OBOE_VERSION} ..."
    echo ""
    cd "$DOWNLOAD_DIR"
    rm -rf "${OBOE_DIR_NAME}"
    mkdir -p "${OBOE_DIR_NAME}"

    # Download the AAR file
    curl -L -# -o oboe.aar "$OBOE_DOWNLOAD_URL" 2>&1
    echo "Oboe downloaded!"

    # Extract the AAR (it's a zip file)
    echo "Extracting Oboe prefab package ..."
    unzip -q oboe.aar -d "${OBOE_DIR_NAME}"
    rm -f oboe.aar

    # Setup output directories
    mkdir -p "${OBOE_BUILD_OUT_PATH}"

    # Copy libraries for each architecture
    echo "Setting up Oboe libraries for target architectures ..."
    for arch in "${TARGET_ARCHS[@]}"
    do
        OBOE_PREFAB_DIR="${OBOE_DIR_NAME}/prefab/modules/oboe/libs/android.${arch}"
        if [ -d "$OBOE_PREFAB_DIR" ]; then
            mkdir -p "${OBOE_BUILD_OUT_PATH}/libs/${arch}/lib"
            mkdir -p "${OBOE_BUILD_OUT_PATH}/libs/${arch}/include"
            cp -r ${OBOE_PREFAB_DIR}/*.so "${OBOE_BUILD_OUT_PATH}/libs/${arch}/lib/" 2>/dev/null || true
            cp -r ${OBOE_PREFAB_DIR}/*.a "${OBOE_BUILD_OUT_PATH}/libs/${arch}/lib/" 2>/dev/null || true
        fi
    done

    # Copy include files (same for all architectures)
    OBOE_INCLUDE_DIR="${OBOE_DIR_NAME}/prefab/modules/oboe/include"
    if [ -d "$OBOE_INCLUDE_DIR" ]; then
        for arch in "${TARGET_ARCHS[@]}"
        do
            cp -r ${OBOE_INCLUDE_DIR}/* "${OBOE_BUILD_OUT_PATH}/libs/${arch}/include/" 2>/dev/null || true
        done
    fi

    echo "Oboe setup completed!"
fi

echo ""
echo "The build system is ready! Execute: ./build to build PJSIP"
